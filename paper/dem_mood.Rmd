---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
    template: svm-latex-ms2.tex
    
title: "Democratic Support as Thermostatic Opinion? A Correction"
thanks: "Corresponding author: [yuehong-tai@uiowa.edu](mailto:yuehong-tai@uiowa.edu). Current version: `r format(Sys.time(), '%B %d, %Y')`."

author:
- name: Yue Hu
  affiliation: Tsinghua University
- name: Yuehong 'Cassandra' Tai
  affiliation: University of Iowa
- name: Frederick Solt
  affiliation: University of Iowa
  
abstract: ""
keywords: ""
fontsize: 12pt
spacing: double
bibliography: \dummy{`r file.path(getwd(), list.files(getwd(), ".bib$", recursive = TRUE))`}
# csl: https://raw.githubusercontent.com/citation-style-language/styles/master/american-political-science-association.csl
biblio-style: apsr
citecolor: black
linkcolor: black
endnote: no
header-includes:
      - \usepackage{array}
      - \usepackage{caption}
      - \usepackage{graphicx}
      - \usepackage{siunitx}
      - \usepackage{colortbl}
      - \usepackage{multirow}
      - \usepackage{hhline}
      - \usepackage{calc}
      - \usepackage{tabularx}
      - \usepackage{threeparttable}
      - \usepackage{wrapfig}

---

Currently from dcpo_dem_mood/paper/dcpo_demsupport_appendix.Rmd; dataset replication code in dcpo_dem_mood/paper/dcpo_demsupport.Rmd may be better

needs dataset comparison from R/compare_supdem_cri.R


```{r setup, include=FALSE}
options(tinytex.verbose = TRUE)

knitr::opts_chunk$set(
    cache = TRUE,
    echo = FALSE,
    message = FALSE,
    warning = FALSE,
    dpi = 600,
    include = FALSE
)

# If you haven't install `DCPOtools`
# remotes::install_github("fsolt/DCPOtools")

if (!require(pacman))
    install.packages("pacman")
library(pacman)

# p_load_gh("fsolt/DCPOtools",
#           "ropensci/osfr")

p_load(
    # data scraping
    dataverse,
    
    # analysis
    plm,
    
    # presenting
    patchwork,
    dotwhisker,
    kableExtra,
    modelsummary,
    ## tabulation
    latex2exp,
    patchwork,
    #rstan, # Bayesian estimation
    
    # munging
    glue,
    here,
    tidyverse # data wrangling
)

theme_set(theme_bw())

# Functions preload
set.seed(313)
source(here("R", "customizedFunctions.R"))

# Data preload
df_compare <- readRDS(here("data", "data_comparison.rds"))
df_correlation <- readRDS(here("data", "data_correlation.rds"))

df_apsr <- readRDS(here("data", "dem_mood_apsr.rds"))
df_apsrCorrected <- readRDS(here("data", "data_apsr_corrected.rds"))

# dotwhisker::small_multiple hacks (showing the labels with latex signs)

body(small_multiple)[[19]] <- substitute(
    p <-
        ggplot(
            df,
            aes(
                y = estimate,
                ymin = conf.low,
                ymax = conf.high,
                x = as.factor(model),
                colour = submodel
            )
        ) +
        do.call(geom_pointrange, point_args) +
        ylab("") + xlab("") +
        facet_grid(
            term ~ .,
            scales = "free_y",
            switch = "y",
            labeller = label_parsed # enable the fancy label
        ) +
        scale_y_continuous(position = "right")
    
)
```


# Data Generation Process Problem in Practice

## Discrepancy of the Published Data from the Full, Available, Correct-Coded Data

There are *many* differences in the survey data (see 'R/compare_supdem_cri.R' and 'paper/ourdata_vs_claassensdata.pdf'), which is why we get different theta estimates.
Two things account for these differences. First, miscodings: in the Asia Barometers, Claassen miscoded evdemoc_asiab, counting the midpoint of its three-point scale as a positive, democracy-supporting response and so resulting in substantial overreports in 35 country-years; in the second wave of the Asian Barometer, he miscoded democsuit_asianb, counting 5 along with 6 through 10 as positive responses, resulting in more modest overreports in 9 country-years; in the Pew surveys, he miscoded impdemoc_pew, counting only the highest value of its four-point scale as a positive response and so resulting in substantial underreports in 91 country-years.  

Second, he counts nonresponses as negative responses (such as in Pakistan in 2005 in the South Asian Barometer, when 636 of 1324 respondents declined to answer whether they considered democracy suitable for their country, and these were all coded as unsupportive responses) yielding underreports, and he does not always employ survey weights, which can shift proportions somewhat in either direction.  Then there are also survey updates, which may also play a role.  The overall correlation of the mean thetas is .95, but the correlation within the time series of individual countries can be much lower, and it is even negative for 15 countries (see 'paper/appendix/dcpo_demsupport_appendix.Rmd' at L365-369).
    
Claassen excludes democextent_asianb observations from asianb3 and asianb4, although he included them from asianb1 and 2.  This accounts for 19 of 38 excluded country-year-items in 'available'.
    
We have lapop 2004 strong coded as strong_amb_1 but Claassen has it coded as strong_lapop_2.  It's really 1, because there's no difference in the item question: "AUT1. Hay gente que dice que necesitamos un líder fuerte que no tenga que ser elegido a través del voto. AUT1 Otros dicen que aunque las cosas no funcionen, la democracia electoral, o sea el voto popular, es siempre
lo mejor. ¿Qué piensa usted? [Leer alternativas]
Necesitamos un líder fuerte que no tenga que ser elegido..................1 La democracia electoral (voto popular) es lo mejor............................2 NS/NR......................................................................................8"

```{r compare_descriptive, fig.cap="Comparision of Proportion of Support Democracy Responses in the Publication and Corrected Data", fig.align='center'}

plot_support <- ggplot(df_compare, 
       aes(x = prop_ours, y = prop_cls)) +
    geom_point(aes(color = p_dcpo, shape = p_dcpo), alpha = 0.5) +
    labs(y = "Publication Data",
         x = "Corrected Data") +
    annotate("text",
             x = .22,
             y = .95,
             label = "evdemoc_asiab accounts\nfor most overreports") +
    annotate("text",
             x = .75,
             y = .13,
             label = "impdemoc_pew accounts for\nmost large underreports") +
    scale_color_discrete(name = "Survey", direction = -1) +
    scale_shape_manual(values = seq(1:length(unique(df_compare$p_dcpo))), 
                       name = "Survey") + 
    ggtitle("Survey Level")

df_plot <- arrange(df_correlation) %>%
    rownames_to_column() %>% 
    mutate(country = factor(country, levels = rev(country)),
           rowname = as.integer(rowname))

vec_bar <- nrow(df_plot) - min(df_plot$rowname[df_plot$corr >= .9]) # where the line is drawn
                               
plot_corr <- ggplot(df_plot, aes(y = country, x = corr)) +
        geom_point() +
        guides(y = guide_axis(n.dodge = 2)) +
    xlab("Correlation") +
    geom_hline(yintercept = vec_bar,
               colour = "grey60", linetype = 2) +
    geom_text(aes(0.98, vec_bar),
              label = "0.9", vjust = -1) +
    theme(axis.title.y = element_blank()) +
    ggtitle("Country Level")

plot_different <- plot_corr + plot_support

ggsave(plot_support, 'images/data_comparison.png') # Stand-alone plot without notes for presentation

tx_note <- str_wrap(
    c(
      "Note: The plots illustate the differences published and currently available data. The left plot shows the country-level correlation of democracy-support proportion between the data used for publication and corrected data. The right plot presents the survey-level differents in terms of the proportion of democracy support. Source: Claassen 2020 and self-collected data"
    ),
    width = 115
  )

plot_support + 
    plot_annotation(caption = tx_note) &
    theme(plot.caption = element_text(hjust = 0, face= "italic"))

```



## Consequence of DGP Problem

```{r regression-result}
sd.plm <- sd.plm2 <- pdata.frame(df_apsr, index = c("Country", "Year")) 

ls_ivECM <- c("diff(Libdem_z, lag = 1) + plm::lag(Libdem_z, 1)", 
              "diff(Polyarchy_z, lag = 1) + plm::lag(Polyarchy_z, 1) + diff(Liberal_z, lag = 1) + plm::lag(Liberal_z, 1)")
ls_ctrlECM <- c("", " + diff(Corrup_TI_z, lag = 1) + plm::lag(Corrup_TI_z, 1)")

ls_eqECM <- glue("diff(SupDem_trim, lag = 1) ~ plm::lag(SupDem_trim, 1:2) + {ls_ivECM} + diff(lnGDP_imp, lag = 1) + plm::lag(lnGDP_imp, 1)") %>% 
  outer(ls_ctrlECM, paste0) %>% 
  as.vector()

ls_ivFD <- c("Libdem_z",
             "Polyarchy_z + Liberal_z")

ls_ctrlFD <- c("", " + Corrup_TI_z")

ls_eqFD <- glue("SupDem_trim ~ {ls_ivFD} + lnGDP_imp") %>% 
  outer(ls_ctrlFD, paste0) %>% 
  as.vector()

ls_mod_original <- c(
  glue("plm({ls_eqECM}, model = 'pooling', data = sd.plm)"),
  glue("plm({ls_eqFD}, model = 'fd', index = 'Country', data = sd.plm)")
)
ls_mod_correct <- c(
  glue("plm({ls_eqECM}, model = 'pooling', data = sd.plm2)"),
  glue("plm({ls_eqFD}, model = 'fd', index = 'Country', data = sd.plm2)")
)

ls_mod <- c(ls_mod_original, ls_mod_correct)

result_clsAPSR <- map(ls_mod, ~eval(parse(text = .)))

result_clsAPSR_tidy <- map(result_clsAPSR, function(aResult) {
  tidy_result <- tidy(aResult, conf.int = TRUE) %>% 
    mutate(std.error = vcovHC_se(aResult))
  
  glance_result <- glance.plm(aResult)
  
  ls_result <- list(tidy_result, glance_result)
})
```


```{r regression-plot, fig.cap= "The Effect of Democracy on Change in Public Support with Uncertainty", fig.width=7, fig.height=10}

txt_models <- paste0("Model ",
                     rep(1:2, each = 4), ".", rep(1:4, 2),
                     " (",
                     rep(c("ECM", "ECM", "FD", "FD"), 2),
                     ")")

vec_numCoef <- map_dbl(c(1, 2, 5, 6, 3, 4, 7, 8), # ECM ECM FD FD
                       ~nrow(result_clsAPSR_tidy[[.]][[1]])) - 1 # subtract the intercepts

txt_model_lab <- map2(txt_models, vec_numCoef, ~rep(.x, times = .y)) %>% 
    unlist # model lists
txt_model_lab <- c(txt_model_lab[str_which(txt_model_lab, "ECM")], 
                   txt_model_lab[str_which(txt_model_lab, "FD")])
# Modify the orders to match the dataset

index_coefName <- c(
    `plm::lag(SupDem_trim, 1:2)1` = "Democratic~Support[t-1]",
    `plm::lag(SupDem_trim, 1:2)2` = "Democratic~Support[t-2]",
    `diff(Libdem_z, lag = 1)` = "Delta~Liberal~democracy",
    `Libdem_z` = "Delta~Liberal~democracy",
    `plm::lag(Libdem_z, 1)` = "Liberal~Democracy[t-1]",
    `diff(Liberal_z, lag = 1)` = "Delta~Electoral~Democracy",
    `Liberal_z` = "Delta~Electoral~Democracy",
    `plm::lag(Liberal_z, 1)` = "Electoral~Democracy[t-1]",
    `diff(Polyarchy_z, lag = 1)` = "Delta~Minoritarian~Democracy",
    `Polyarchy_z` = "Delta~Minoritarian~Democracy",
    `plm::lag(Polyarchy_z, 1)` = "Minoritarian~Democracy[t-1]",
    `diff(lnGDP_imp, lag = 1)` = "Delta~Log~GDP~per~capita",
    `lnGDP_imp` = "Delta~Log~GDP~per~capita",
    `plm::lag(lnGDP_imp, 1)` = "Log~GDP~per~capita[t-1]",
    `diff(Corrup_TI_z, lag = 1)` = "Delta~Corruption",
    `Corrup_TI_z` = "Delta~Corruption",
    `plm::lag(Corrup_TI_z, 1)` = "Corruption[t-1]"
)

df_plot <- map_dfr(result_clsAPSR_tidy, ~.[[1]]) %>% 
    filter(term != "(Intercept)") %>%
    mutate(
        type = ifelse(str_detect(term, "(_z|imp)$"), "FD", "ECM"),
        term = index_coefName[term],
        term = factor(term, levels = unique(index_coefName)),
        submodel = rep(c("Published", "Corrected"), each = nrow(.)/2),
        submodel = factor(submodel, levels = c("Published","Corrected")),
        model = rep(txt_model_lab, times = 2),
        model = factor(model, levels = txt_models)
    )

txt_caption <- strwrap("Note: Replications of Claassen (2020), Table 1, 47, and Table 2, 49.  Models denoted 'ECM' are error-correction models; those marked 'FD' are first-difference models.", width = 85) %>% 
  paste0(sep="", collapse="\n")

small_multiple(df_plot, axis_switch = TRUE, dot_args = list(size = .9, fatten = 1)) +
    geom_hline(yintercept = 0, colour = "grey50", linetype = 2) +
    scale_color_grey(start = 0.8, end = 0.4, 
                     name = "Replication",
                     breaks = c("Published",
                              "Corrected"),
                     labels = c("Publication data",
                              "Full, corrected data")) +
    theme(axis.text.x  = element_text(angle = 90, hjust = .5),
          strip.text.y.left = element_text(angle = 0),
          legend.position = c(0.006, -.01),
          legend.justification = c(1, 1), 
          legend.title = element_text(size = 9, face = "bold"),
          legend.title.align = 0.5,
          legend.text = element_text(size = 8),
          legend.background = element_rect(color="gray90"),
          legend.spacing = unit(-5, "pt"),
          legend.key.width = unit(4.5, "mm"),
          legend.key.height = unit(7, "mm"),
          plot.caption = element_text(size = 10, hjust = 0.2, margin = margin(t=15))) +
  guides(color = guide_legend(override.aes = list(size=.3))) +
  ggtitle("Dependent Variable: Change in Public Democratic Support") +
  labs(caption = txt_caption)

```




\pagebreak
